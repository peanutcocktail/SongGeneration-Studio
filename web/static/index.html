<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SongGeneration Studio</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #1e1e1e;
            font-family: 'Inter', -apple-system, sans-serif;
            color: #e0e0e0;
            min-height: 100vh;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3a3a3a; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4a4a4a; }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: #3a3a3a;
            border-radius: 2px;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 14px;
            height: 14px;
            background: #10B981;
            border-radius: 50%;
            cursor: pointer;
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 8L2 4h8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
        }

        textarea::placeholder, input::placeholder {
            color: #555;
        }

        /* Add Section Popup - fixed position */
        .add-section-popup {
            position: fixed;
            background-color: #2a2a2a;
            border: 1px solid #3a3a3a;
            border-radius: 12px;
            padding: 8px;
            z-index: 10000;
            min-width: 160px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.6);
        }

        .add-section-popup button {
            display: block;
            width: 100%;
            padding: 10px 14px;
            border-radius: 8px;
            border: none;
            background-color: transparent;
            cursor: pointer;
            text-align: left;
            font-size: 13px;
            font-weight: 500;
            transition: background 0.15s;
        }

        .add-section-popup button:hover {
            background-color: #3a3a3a;
        }

        /* Indeterminate progress bar animation */
        @keyframes indeterminate {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(400%);
            }
        }

        .progress-bar-indeterminate {
            position: relative;
            overflow: hidden;
            background: #333;
        }

        .progress-bar-indeterminate::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 30%;
            height: 100%;
            background: linear-gradient(90deg, transparent, #10B981, transparent);
            animation: indeterminate 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect, useRef, useCallback } = React;

const SECTION_TYPES = {
    'intro': { name: 'Intro', color: '#8B5CF6', hasLyrics: false, hasDuration: true },
    'verse': { name: 'Verse', color: '#3B82F6', hasLyrics: true, hasDuration: false },
    'chorus': { name: 'Chorus', color: '#F59E0B', hasLyrics: true, hasDuration: false },
    'bridge': { name: 'Bridge', color: '#EC4899', hasLyrics: true, hasDuration: false },
    'inst': { name: 'Inst', color: '#10B981', hasLyrics: false, hasDuration: true },
    'outro': { name: 'Outro', color: '#EAB308', hasLyrics: false, hasDuration: true },
};

// Custom dark audio player component
const DarkAudioPlayer = ({ src }) => {
    const audioRef = useRef(null);
    const [isPlaying, setIsPlaying] = useState(false);
    const [currentTime, setCurrentTime] = useState(0);
    const [duration, setDuration] = useState(0);
    const [volume, setVolume] = useState(1);

    const formatTime = (time) => {
        if (!time || isNaN(time)) return '0:00';
        const mins = Math.floor(time / 60);
        const secs = Math.floor(time % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    };

    const togglePlay = () => {
        if (audioRef.current) {
            if (isPlaying) {
                audioRef.current.pause();
            } else {
                audioRef.current.play();
            }
            setIsPlaying(!isPlaying);
        }
    };

    const handleTimeUpdate = () => {
        if (audioRef.current) {
            setCurrentTime(audioRef.current.currentTime);
        }
    };

    const handleLoadedMetadata = () => {
        if (audioRef.current) {
            setDuration(audioRef.current.duration);
        }
    };

    const handleSeek = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        const percent = (e.clientX - rect.left) / rect.width;
        if (audioRef.current) {
            audioRef.current.currentTime = percent * duration;
        }
    };

    const handleEnded = () => {
        setIsPlaying(false);
        setCurrentTime(0);
    };

    const progress = duration > 0 ? (currentTime / duration) * 100 : 0;

    return (
        <div style={{
            display: 'flex',
            alignItems: 'center',
            gap: '12px',
            backgroundColor: '#1a1a1a',
            borderRadius: '8px',
            padding: '10px 14px',
            flex: 1,
        }}>
            <audio
                ref={audioRef}
                src={src}
                onTimeUpdate={handleTimeUpdate}
                onLoadedMetadata={handleLoadedMetadata}
                onEnded={handleEnded}
                onPlay={() => setIsPlaying(true)}
                onPause={() => setIsPlaying(false)}
            />

            {/* Play/Pause button */}
            <button
                onClick={togglePlay}
                style={{
                    width: '32px',
                    height: '32px',
                    borderRadius: '50%',
                    border: 'none',
                    backgroundColor: '#10B981',
                    color: '#fff',
                    cursor: 'pointer',
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'center',
                    flexShrink: 0,
                }}
            >
                {isPlaying ? (
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                        <rect x="2" y="1" width="3" height="10" rx="1" />
                        <rect x="7" y="1" width="3" height="10" rx="1" />
                    </svg>
                ) : (
                    <svg width="12" height="12" viewBox="0 0 12 12" fill="currentColor">
                        <path d="M2 1.5v9l8-4.5-8-4.5z" />
                    </svg>
                )}
            </button>

            {/* Time */}
            <span style={{ fontSize: '12px', color: '#888', minWidth: '70px' }}>
                {formatTime(currentTime)} / {formatTime(duration)}
            </span>

            {/* Progress bar */}
            <div
                onClick={handleSeek}
                style={{
                    flex: 1,
                    height: '6px',
                    backgroundColor: '#333',
                    borderRadius: '3px',
                    cursor: 'pointer',
                    position: 'relative',
                }}
            >
                <div style={{
                    width: `${progress}%`,
                    height: '100%',
                    backgroundColor: '#10B981',
                    borderRadius: '3px',
                    transition: 'width 0.1s',
                }} />
            </div>

            {/* Volume */}
            <div style={{ display: 'flex', alignItems: 'center', gap: '6px' }}>
                <svg width="16" height="16" viewBox="0 0 24 24" fill="#666">
                    <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/>
                </svg>
                <input
                    type="range"
                    min="0"
                    max="1"
                    step="0.1"
                    value={volume}
                    onChange={(e) => {
                        const v = parseFloat(e.target.value);
                        setVolume(v);
                        if (audioRef.current) audioRef.current.volume = v;
                    }}
                    style={{ width: '60px', height: '4px' }}
                />
            </div>
        </div>
    );
};

const fromApiType = (apiType) => {
    const match = apiType.match(/^(.+?)(?:-(short|medium|long))?$/);
    return match ? { base: match[1], duration: match[2] || 'short' } : { base: apiType, duration: null };
};

const GENRE_SUGGESTIONS = ['Pop', 'Rock', 'Metal', 'Jazz', 'R&B', 'Folk', 'Dance', 'Electronic', 'Hip Hop', 'Trap', 'Lo-fi', 'Synthwave', 'Punk', 'Blues', 'Country', 'Ambient', 'Soul', 'Funk', 'Reggae', 'Indie', 'EDM'];
const MOOD_SUGGESTIONS = ['happy', 'sad', 'energetic', 'romantic', 'angry', 'peaceful', 'melancholic', 'hopeful', 'aggressive', 'dreamy', 'nostalgic', 'euphoric', 'dark', 'chill', 'epic', 'intense'];
const TIMBRE_SUGGESTIONS = ['bright', 'dark', 'soft', 'powerful', 'warm', 'clear', 'raspy', 'smooth', 'breathy', 'ethereal', 'gravelly', 'operatic'];

const Card = ({ children }) => (
    <div style={{
        backgroundColor: '#282828',
        borderRadius: '16px',
        padding: '20px',
    }}>
        {children}
    </div>
);

const CardTitle = ({ children }) => (
    <div style={{ fontSize: '13px', fontWeight: '500', color: '#888', marginBottom: '14px' }}>
        {children}
    </div>
);

const MultiSelect = ({ suggestions, selected, onChange, placeholder }) => {
    const [input, setInput] = useState('');
    const [showDropdown, setShowDropdown] = useState(false);

    const addTag = (tag) => {
        if (tag && !selected.includes(tag)) onChange([...selected, tag]);
        setInput('');
        setShowDropdown(false);
    };

    const removeTag = (tag) => onChange(selected.filter(t => t !== tag));

    const handleKeyDown = (e) => {
        if (e.key === 'Enter' && input.trim()) { e.preventDefault(); addTag(input.trim()); }
        else if (e.key === 'Backspace' && !input && selected.length) removeTag(selected[selected.length - 1]);
    };

    const filtered = suggestions.filter(s => s.toLowerCase().includes(input.toLowerCase()) && !selected.includes(s));

    return (
        <div style={{ position: 'relative' }}>
            <div style={{
                backgroundColor: '#1e1e1e',
                border: '1px solid #3a3a3a',
                borderRadius: '10px',
                padding: '10px 12px',
                minHeight: '42px',
                display: 'flex',
                flexWrap: 'wrap',
                gap: '6px',
                alignItems: 'center',
                cursor: 'text',
            }} onClick={() => setShowDropdown(true)}>
                {selected.map(tag => (
                    <span key={tag} style={{
                        backgroundColor: '#3a3a3a',
                        color: '#e0e0e0',
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '6px',
                    }}>
                        {tag}
                        <span style={{ cursor: 'pointer', opacity: 0.6, fontSize: '14px' }} onClick={(e) => { e.stopPropagation(); removeTag(tag); }}>x</span>
                    </span>
                ))}
                <input
                    type="text"
                    value={input}
                    onChange={e => { setInput(e.target.value); setShowDropdown(true); }}
                    onFocus={() => setShowDropdown(true)}
                    onBlur={() => setTimeout(() => setShowDropdown(false), 200)}
                    onKeyDown={handleKeyDown}
                    placeholder={selected.length === 0 ? placeholder : ''}
                    style={{
                        border: 'none',
                        background: 'transparent',
                        color: '#e0e0e0',
                        fontSize: '13px',
                        outline: 'none',
                        flex: 1,
                        minWidth: '60px',
                    }}
                />
            </div>
            {showDropdown && filtered.length > 0 && (
                <div style={{
                    position: 'absolute',
                    top: '100%',
                    left: 0,
                    right: 0,
                    backgroundColor: '#2a2a2a',
                    border: '1px solid #3a3a3a',
                    borderRadius: '10px',
                    marginTop: '4px',
                    maxHeight: '180px',
                    overflowY: 'auto',
                    zIndex: 100,
                    boxShadow: '0 8px 24px rgba(0,0,0,0.4)',
                }}>
                    {filtered.slice(0, 8).map(s => (
                        <div
                            key={s}
                            onMouseDown={() => addTag(s)}
                            style={{ padding: '10px 14px', cursor: 'pointer', fontSize: '13px', transition: 'background 0.15s' }}
                            onMouseEnter={e => e.target.style.backgroundColor = '#3a3a3a'}
                            onMouseLeave={e => e.target.style.backgroundColor = 'transparent'}
                        >
                            {s}
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};

const SectionCard = ({ section, onUpdate, onRemove }) => {
    const { base } = fromApiType(section.type);
    const cfg = SECTION_TYPES[base] || { name: base, color: '#888', hasLyrics: true };
    const lineCount = Math.max(3, (section.lyrics || '').split('\n').length + 1);

    return (
        <div style={{
            backgroundColor: '#282828',
            borderRadius: '12px',
            borderLeft: `4px solid ${cfg.color}`,
            overflow: 'hidden',
        }}>
            <div style={{
                padding: '14px 18px',
                display: 'flex',
                justifyContent: 'space-between',
                alignItems: 'center',
            }}>
                <span style={{ fontSize: '15px', fontWeight: '500', color: cfg.color }}>{cfg.name}</span>
                <button
                    onClick={onRemove}
                    style={{
                        background: 'transparent',
                        border: 'none',
                        color: '#555',
                        cursor: 'pointer',
                        fontSize: '20px',
                        padding: '4px 8px',
                        lineHeight: 1,
                        transition: 'color 0.15s',
                    }}
                    onMouseEnter={e => e.target.style.color = '#888'}
                    onMouseLeave={e => e.target.style.color = '#555'}
                >x</button>
            </div>
            <div style={{ padding: '0 18px 16px 18px' }}>
                {cfg.hasLyrics ? (
                    <textarea
                        value={section.lyrics || ''}
                        onChange={e => onUpdate({ lyrics: e.target.value })}
                        placeholder="Enter lyrics..."
                        rows={lineCount}
                        style={{
                            width: '100%',
                            backgroundColor: 'transparent',
                            border: 'none',
                            color: '#999',
                            fontSize: '14px',
                            lineHeight: '1.8',
                            resize: 'none',
                            outline: 'none',
                        }}
                    />
                ) : (
                    <div style={{ color: '#555', fontSize: '14px', textAlign: 'center', padding: '16px 0' }}>
                        Instrumental
                    </div>
                )}
            </div>
        </div>
    );
};

const LibraryItem = ({ item }) => {
    const [expanded, setExpanded] = useState(false);
    const meta = item.metadata || {};

    const formatDate = (dateStr) => {
        if (!dateStr) return 'Unknown';
        try {
            return new Date(dateStr).toLocaleString();
        } catch { return dateStr; }
    };

    const formatDuration = (start, end) => {
        if (!start || !end) return '';
        try {
            const ms = new Date(end) - new Date(start);
            const mins = Math.floor(ms / 60000);
            const secs = Math.floor((ms % 60000) / 1000);
            return `${mins}m ${secs}s`;
        } catch { return ''; }
    };

    return (
        <div style={{
            backgroundColor: '#282828',
            borderRadius: '12px',
            padding: '16px',
            display: 'flex',
            flexDirection: 'column',
            gap: '12px',
        }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                <div style={{ flex: 1 }}>
                    <div style={{ fontSize: '15px', fontWeight: '500', color: '#e0e0e0' }}>{item.title || 'Untitled'}</div>
                    <div style={{ fontSize: '12px', color: '#888', marginTop: '4px' }}>
                        {formatDate(item.created_at)}
                        {meta.model && <span style={{ marginLeft: '12px', color: '#666' }}>{meta.model}</span>}
                    </div>
                    {/* Style tags */}
                    <div style={{ display: 'flex', gap: '6px', marginTop: '8px', flexWrap: 'wrap' }}>
                        {meta.gender && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#3B82F620', color: '#3B82F6' }}>{meta.gender}</span>}
                        {meta.genre && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#8B5CF620', color: '#8B5CF6' }}>{meta.genre}</span>}
                        {meta.emotion && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#F59E0B20', color: '#F59E0B' }}>{meta.emotion}</span>}
                        {meta.bpm && <span style={{ padding: '2px 8px', borderRadius: '4px', fontSize: '11px', backgroundColor: '#10B98120', color: '#10B981' }}>{meta.bpm} BPM</span>}
                    </div>
                </div>
                <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                    <button
                        onClick={() => setExpanded(!expanded)}
                        style={{
                            background: 'none',
                            border: '1px solid #444',
                            borderRadius: '6px',
                            padding: '4px 10px',
                            color: '#888',
                            cursor: 'pointer',
                            fontSize: '12px',
                        }}
                    >
                        {expanded ? 'Hide' : 'Details'}
                    </button>
                    <span style={{
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '11px',
                        fontWeight: '500',
                        backgroundColor: item.status === 'completed' ? '#10B98120' : item.status === 'failed' ? '#EF444420' : '#F59E0B20',
                        color: item.status === 'completed' ? '#10B981' : item.status === 'failed' ? '#EF4444' : '#F59E0B',
                    }}>
                        {item.status}
                    </span>
                </div>
            </div>

            {/* Audio players */}
            {item.status === 'completed' && item.output_files?.map((f, i) => (
                <DarkAudioPlayer key={i} src={`/api/audio/${item.id}/${i}`} />
            ))}

            {/* Expanded details */}
            {expanded && (
                <div style={{
                    backgroundColor: '#1a1a1a',
                    borderRadius: '8px',
                    padding: '12px',
                    fontSize: '12px',
                    display: 'grid',
                    gridTemplateColumns: 'repeat(2, 1fr)',
                    gap: '8px 16px',
                }}>
                    <div><span style={{ color: '#666' }}>Model:</span> <span style={{ color: '#aaa' }}>{meta.model || 'unknown'}</span></div>
                    <div><span style={{ color: '#666' }}>Output Mode:</span> <span style={{ color: '#aaa' }}>{meta.output_mode || 'mixed'}</span></div>
                    <div><span style={{ color: '#666' }}>Voice:</span> <span style={{ color: '#aaa' }}>{meta.gender || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Timbre:</span> <span style={{ color: '#aaa' }}>{meta.timbre || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Genre:</span> <span style={{ color: '#aaa' }}>{meta.genre || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Mood:</span> <span style={{ color: '#aaa' }}>{meta.emotion || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>BPM:</span> <span style={{ color: '#aaa' }}>{meta.bpm || '-'}</span></div>
                    <div><span style={{ color: '#666' }}>Instruments:</span> <span style={{ color: '#aaa' }}>{meta.instruments || '-'}</span></div>
                    <div style={{ gridColumn: '1 / -1' }}><span style={{ color: '#666' }}>Created:</span> <span style={{ color: '#aaa' }}>{formatDate(meta.created_at)}</span></div>
                    {meta.completed_at && (
                        <div style={{ gridColumn: '1 / -1' }}><span style={{ color: '#666' }}>Completed:</span> <span style={{ color: '#aaa' }}>{formatDate(meta.completed_at)} ({formatDuration(meta.created_at, meta.completed_at)})</span></div>
                    )}
                    {meta.description && (
                        <div style={{ gridColumn: '1 / -1', marginTop: '8px' }}>
                            <div style={{ color: '#666', marginBottom: '4px' }}>Description sent to model:</div>
                            <div style={{ color: '#10B981', fontFamily: 'monospace', fontSize: '11px', padding: '8px', backgroundColor: '#0a0a0a', borderRadius: '4px' }}>{meta.description}</div>
                        </div>
                    )}
                    {meta.sections && meta.sections.length > 0 && (
                        <div style={{ gridColumn: '1 / -1', marginTop: '8px' }}>
                            <div style={{ color: '#666', marginBottom: '4px' }}>Sections ({meta.sections.length}):</div>
                            <div style={{ display: 'flex', flexDirection: 'column', gap: '4px' }}>
                                {meta.sections.map((s, i) => (
                                    <div key={i} style={{ padding: '8px 10px', backgroundColor: '#0a0a0a', borderRadius: '4px', borderLeft: `3px solid ${SECTION_TYPES[s.type]?.color || '#666'}` }}>
                                        <div style={{ color: SECTION_TYPES[s.type]?.color || '#888', fontWeight: '500', marginBottom: s.lyrics ? '6px' : '0' }}>[{s.type}]</div>
                                        {s.lyrics && <div style={{ color: '#999', whiteSpace: 'pre-wrap', lineHeight: '1.5', fontSize: '11px' }}>{s.lyrics}</div>}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    {meta.reference_audio && (
                        <div style={{ gridColumn: '1 / -1' }}><span style={{ color: '#666' }}>Reference Audio:</span> <span style={{ color: '#F59E0B' }}>Yes (style cloning)</span></div>
                    )}
                </div>
            )}
        </div>
    );
};

const App = () => {
    const [activeTab, setActiveTab] = useState('create');
    const [sections, setSections] = useState([
        { id: '1', type: 'intro-short', lyrics: '' },
        { id: '2', type: 'verse', lyrics: '' },
        { id: '3', type: 'chorus', lyrics: '' },
        { id: '4', type: 'verse', lyrics: '' },
        { id: '5', type: 'outro-short', lyrics: '' },
    ]);
    const [title, setTitle] = useState('My New Song');
    const [gender, setGender] = useState('female');
    const [genres, setGenres] = useState(['Pop']);
    const [moods, setMoods] = useState([]);
    const [timbres, setTimbres] = useState([]);
    const [instruments, setInstruments] = useState('');
    const [bpm, setBpm] = useState(120);
    const [outputMode, setOutputMode] = useState('mixed');
    const [memoryMode, setMemoryMode] = useState('auto');
    const [models, setModels] = useState([]);
    const [selectedModel, setSelectedModel] = useState('songgeneration_base');
    const [generating, setGenerating] = useState(false);
    const [progress, setProgress] = useState(0);
    const [status, setStatus] = useState('');
    const [error, setError] = useState(null);
    const [audio, setAudio] = useState(null);
    const [showAddMenu, setShowAddMenu] = useState(false);
    const [addMenuPos, setAddMenuPos] = useState({ x: 0, y: 0 });
    const [library, setLibrary] = useState([]);
    const [refFile, setRefFile] = useState(null);
    const [refId, setRefId] = useState(null);
    const [useReference, setUseReference] = useState(false);
    const [genStartTime, setGenStartTime] = useState(null);
    const [estimatedTime, setEstimatedTime] = useState(null);
    const [elapsedTime, setElapsedTime] = useState(0);
    const pollRef = useRef(null);
    const fileRef = useRef(null);
    const addBtnRef = useRef(null);
    const timerRef = useRef(null);

    useEffect(() => { loadModels(); loadLibrary(); }, []);
    useEffect(() => () => {
        pollRef.current && clearInterval(pollRef.current);
        timerRef.current && clearInterval(timerRef.current);
    }, []);

    // Time estimation based on model and lyrics
    const estimateGenerationTime = useCallback((model, sectionsList) => {
        // Base times in seconds for each model (approximate)
        const modelBaseTimes = {
            'songgeneration_base': 180,       // ~3 minutes
            'songgeneration_base_new': 200,   // ~3.5 minutes
            'songgeneration_base_full': 300,  // ~5 minutes (longer output)
            'songgeneration_large': 420,      // ~7 minutes (best quality, longer)
        };

        // Get base time for model
        let baseTime = modelBaseTimes[model] || 240; // default 4 minutes

        // Calculate total lyrics length
        const totalLyrics = sectionsList.reduce((acc, s) => {
            return acc + (s.lyrics || '').length;
        }, 0);

        // Calculate number of sections
        const numSections = sectionsList.length;

        // Adjust time based on lyrics length (more lyrics = more time)
        // ~30 seconds per 500 characters
        const lyricsTimeAdjust = Math.floor(totalLyrics / 500) * 30;

        // Adjust for number of sections (~10 seconds per section beyond 3)
        const sectionsAdjust = Math.max(0, numSections - 3) * 10;

        // Count instrumental/duration sections (they add time)
        const durationSections = sectionsList.filter(s =>
            s.type.includes('intro') || s.type.includes('outro') || s.type.includes('inst')
        ).length;
        const durationAdjust = durationSections * 15;

        return baseTime + lyricsTimeAdjust + sectionsAdjust + durationAdjust;
    }, []);

    const formatTimeRemaining = (seconds) => {
        if (seconds <= 0) return 'finishing...';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        if (mins > 0) {
            return `~${mins}m ${secs}s remaining`;
        }
        return `~${secs}s remaining`;
    };

    // Close popup when clicking outside
    useEffect(() => {
        const handleClick = (e) => {
            if (showAddMenu && addBtnRef.current && !addBtnRef.current.contains(e.target)) {
                setShowAddMenu(false);
            }
        };
        document.addEventListener('click', handleClick);
        return () => document.removeEventListener('click', handleClick);
    }, [showAddMenu]);

    const loadModels = async () => {
        try {
            const r = await fetch('/api/models');
            if (r.ok) {
                const d = await r.json();
                setModels(d.models || []);
                if (d.default) setSelectedModel(d.default);
            }
        } catch (e) { console.error(e); }
    };

    const loadLibrary = async () => {
        try {
            const r = await fetch('/api/generations');
            if (r.ok) {
                const data = await r.json();
                setLibrary(data.sort((a, b) => new Date(b.created_at) - new Date(a.created_at)));
            }
        } catch (e) { console.error(e); }
    };

    const uploadReference = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        setRefFile(file);
        setError(null);
        const fd = new FormData();
        fd.append('file', file);
        try {
            const r = await fetch('/api/upload-reference', { method: 'POST', body: fd });
            if (!r.ok) throw new Error(await r.text());
            const data = await r.json();
            setRefId(data.id);
            setUseReference(true);
        } catch (e) {
            setError(e.message);
            setRefFile(null);
        }
    };

    const clearReference = () => {
        setRefFile(null);
        setRefId(null);
        setUseReference(false);
    };

    const poll = useCallback(async (id) => {
        try {
            const r = await fetch(`/api/generation/${id}`);
            if (!r.ok) return;
            const d = await r.json();
            setProgress(d.progress);
            setStatus(d.message);
            if (d.status === 'completed') {
                clearInterval(pollRef.current);
                clearInterval(timerRef.current);
                setGenerating(false);
                setAudio({ id, files: d.output_files });
                setGenStartTime(null);
                setEstimatedTime(null);
                setElapsedTime(0);
                loadLibrary();
            } else if (d.status === 'failed') {
                clearInterval(pollRef.current);
                clearInterval(timerRef.current);
                setGenerating(false);
                setError(d.message);
                setGenStartTime(null);
                setEstimatedTime(null);
                setElapsedTime(0);
            }
        } catch (e) { console.error(e); }
    }, []);

    const generate = async () => {
        setGenerating(true);
        setProgress(0);
        setStatus('Starting...');
        setError(null);
        setAudio(null);

        // Set up time estimation
        const estimated = estimateGenerationTime(selectedModel, sections);
        setEstimatedTime(estimated);
        setGenStartTime(Date.now());
        setElapsedTime(0);

        // Start elapsed time counter
        timerRef.current = setInterval(() => {
            setElapsedTime(prev => prev + 1);
        }, 1000);

        const payload = {
            title,
            sections: sections.map(s => ({ type: s.type, lyrics: s.lyrics || null })),
            gender,
            timbre: timbres.join(', '),
            genre: genres.join(', '),
            emotion: moods.join(', '),
            instruments,
            bpm,
            output_mode: outputMode,
            model: selectedModel,
            memory_mode: memoryMode,
            reference_audio_id: useReference ? refId : null,
        };

        try {
            const r = await fetch('/api/generate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!r.ok) throw new Error(await r.text());
            const { generation_id } = await r.json();
            pollRef.current = setInterval(() => poll(generation_id), 2000);
        } catch (e) {
            setGenerating(false);
            setError(e.message);
        }
    };

    const toggleAddMenu = (e) => {
        e.stopPropagation();
        if (!showAddMenu) {
            const rect = e.currentTarget.getBoundingClientRect();
            const popupHeight = 280; // Approximate height of popup
            const spaceBelow = window.innerHeight - rect.bottom;
            const openUpward = spaceBelow < popupHeight;

            setAddMenuPos({
                x: rect.left,
                y: openUpward ? rect.top : rect.bottom + 8,
                openUpward
            });
        }
        setShowAddMenu(!showAddMenu);
    };

    const addSection = (base) => {
        const cfg = SECTION_TYPES[base];
        const type = cfg?.hasDuration ? `${base}-short` : base;
        setSections([...sections, { id: Date.now().toString(), type, lyrics: '' }]);
        setShowAddMenu(false);
    };

    const removeSection = (id) => setSections(sections.filter(s => s.id !== id));
    const updateSection = (id, updates) => setSections(sections.map(s => s.id === id ? { ...s, ...updates } : s));

    const handleDragStart = (e, id) => { e.dataTransfer.setData('text/plain', id); e.dataTransfer.effectAllowed = 'move'; };
    const handleDragOver = (e) => { e.preventDefault(); };
    const handleDrop = (e, targetId) => {
        e.preventDefault();
        const dragId = e.dataTransfer.getData('text/plain');
        if (dragId === targetId) return;
        const dragIndex = sections.findIndex(s => s.id === dragId);
        const targetIndex = sections.findIndex(s => s.id === targetId);
        const newSections = [...sections];
        const [removed] = newSections.splice(dragIndex, 1);
        newSections.splice(targetIndex, 0, removed);
        setSections(newSections);
    };

    const btnStyle = (isActive, activeColor = '#10B981') => ({
        flex: 1,
        padding: '10px 16px',
        borderRadius: '10px',
        border: 'none',
        fontSize: '13px',
        fontWeight: '500',
        cursor: 'pointer',
        transition: 'all 0.15s',
        backgroundColor: isActive ? activeColor : '#1e1e1e',
        color: isActive ? '#fff' : '#777',
    });

    // Calculate footer height for padding
    const footerHeight = 70;

    return (
        <div style={{
            height: '100vh',
            backgroundColor: '#1e1e1e',
            display: 'flex',
            flexDirection: 'column',
            overflow: 'hidden',
        }}>
            {/* Header */}
            <header style={{
                display: 'flex',
                justifyContent: 'center',
                alignItems: 'center',
                padding: '20px 24px',
                maxWidth: '1400px',
                margin: '0 auto',
                width: '100%',
                boxSizing: 'border-box',
                flexShrink: 0,
                position: 'relative',
            }}>
                <div style={{ position: 'absolute', left: '24px', display: 'flex', alignItems: 'center', gap: '12px' }}>
                    <img src="/static/Logo_1.png" alt="SongGeneration" style={{ height: '36px' }} />
                    <div>
                        <div style={{ fontSize: '18px', fontWeight: '600', color: '#e0e0e0' }}>SongGeneration Studio</div>
                        <div style={{ fontSize: '11px', color: '#666' }}>by Tencent AI Lab</div>
                    </div>
                </div>

                {/* Tabs - Centered */}
                <div style={{ display: 'flex', gap: '4px', backgroundColor: '#282828', padding: '4px', borderRadius: '12px' }}>
                    <button
                        onClick={() => setActiveTab('create')}
                        style={{
                            padding: '10px 24px',
                            borderRadius: '10px',
                            border: 'none',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            backgroundColor: activeTab === 'create' ? '#10B981' : 'transparent',
                            color: activeTab === 'create' ? '#fff' : '#888',
                            transition: 'all 0.15s',
                        }}
                    >
                        Create
                    </button>
                    <button
                        onClick={() => { setActiveTab('library'); loadLibrary(); }}
                        style={{
                            padding: '10px 24px',
                            borderRadius: '10px',
                            border: 'none',
                            fontSize: '14px',
                            fontWeight: '500',
                            cursor: 'pointer',
                            backgroundColor: activeTab === 'library' ? '#10B981' : 'transparent',
                            color: activeTab === 'library' ? '#fff' : '#888',
                            transition: 'all 0.15s',
                        }}
                    >
                        Library
                    </button>
                </div>

                <div style={{ position: 'absolute', right: '24px', fontSize: '11px', color: '#888', textAlign: 'right' }}>
                    <div>UI by <a href="https://bazed.org" target="_blank" style={{ color: '#10B981', textDecoration: 'none' }}>Bazed.org</a></div>
                </div>
            </header>

            {/* Scrollable Content Area */}
            <div style={{
                flex: 1,
                overflowY: 'auto',
                overflowX: 'hidden',
            }}>
                {/* Create View */}
                <div style={{ display: activeTab === 'create' ? 'block' : 'none' }}>
                    <div style={{ display: 'flex', gap: '24px', maxWidth: '1400px', margin: '0 auto', padding: '0 24px 24px 24px' }}>
                    {/* Sidebar */}
                    <aside style={{ width: '320px', flexShrink: 0, display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        {/* Model */}
                        <Card>
                            <CardTitle>Model</CardTitle>
                            <select
                                value={selectedModel}
                                onChange={e => setSelectedModel(e.target.value)}
                                style={{
                                    width: '100%',
                                    backgroundColor: '#1e1e1e',
                                    border: '1px solid #3a3a3a',
                                    borderRadius: '10px',
                                    padding: '12px 14px',
                                    color: '#e0e0e0',
                                    fontSize: '13px',
                                    cursor: 'pointer',
                                    outline: 'none',
                                }}
                            >
                                {models.map(m => <option key={m.id} value={m.id}>{m.name} - {m.description}</option>)}
                                {models.length === 0 && <option value="">Loading...</option>}
                            </select>
                        </Card>

                        {/* Memory Mode */}
                        <Card>
                            <CardTitle>Memory Mode</CardTitle>
                            <div style={{ display: 'flex', gap: '8px' }}>
                                {['auto', 'low', 'high'].map(mode => (
                                    <button key={mode} onClick={() => setMemoryMode(mode)} style={btnStyle(memoryMode === mode)}>
                                        {mode.charAt(0).toUpperCase() + mode.slice(1)}
                                    </button>
                                ))}
                            </div>
                        </Card>

                        {/* Song Settings */}
                        <Card>
                            <CardTitle>Song Settings</CardTitle>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Voice</div>
                                <div style={{ display: 'flex', gap: '8px' }}>
                                    <button onClick={() => setGender('female')} style={btnStyle(gender === 'female', '#3B82F6')}>Female</button>
                                    <button onClick={() => setGender('male')} style={btnStyle(gender === 'male', '#3B82F6')}>Male</button>
                                </div>
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Genre</div>
                                <MultiSelect suggestions={GENRE_SUGGESTIONS} selected={genres} onChange={setGenres} placeholder="Select or type..." />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Mood</div>
                                <MultiSelect suggestions={MOOD_SUGGESTIONS} selected={moods} onChange={setMoods} placeholder="Select or type..." />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Timbre</div>
                                <MultiSelect suggestions={TIMBRE_SUGGESTIONS} selected={timbres} onChange={setTimbres} placeholder="Select or type..." />
                            </div>

                            <div style={{ marginBottom: '16px' }}>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px' }}>Instruments</div>
                                <input
                                    type="text"
                                    value={instruments}
                                    onChange={e => setInstruments(e.target.value)}
                                    placeholder="e.g. piano, guitar, drums..."
                                    style={{
                                        width: '100%',
                                        backgroundColor: '#1e1e1e',
                                        border: '1px solid #3a3a3a',
                                        borderRadius: '10px',
                                        padding: '12px 14px',
                                        color: '#e0e0e0',
                                        fontSize: '13px',
                                        outline: 'none',
                                    }}
                                />
                            </div>

                            <div>
                                <div style={{ fontSize: '12px', color: '#666', marginBottom: '8px', display: 'flex', justifyContent: 'space-between' }}>
                                    <span>BPM</span><span style={{ color: '#10B981', fontWeight: '500' }}>{bpm}</span>
                                </div>
                                <input type="range" min="60" max="180" value={bpm} onChange={e => setBpm(+e.target.value)} />
                            </div>
                        </Card>

                        {/* Reference Audio */}
                        <Card>
                            <CardTitle>Reference Audio</CardTitle>
                            <input ref={fileRef} type="file" accept="audio/*" onChange={uploadReference} style={{ display: 'none' }} />
                            {refFile ? (
                                <div style={{
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '12px',
                                    backgroundColor: '#1e1e1e',
                                    padding: '12px 14px',
                                    borderRadius: '10px',
                                    border: '1px solid #3a3a3a',
                                }}>
                                    <div style={{ fontSize: '18px' }}>&#x1F3B5;</div>
                                    <div style={{ flex: 1, overflow: 'hidden' }}>
                                        <div style={{ fontSize: '13px', color: '#e0e0e0', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' }}>{refFile.name}</div>
                                    </div>
                                    <button onClick={clearReference} style={{ background: 'transparent', border: 'none', color: '#666', cursor: 'pointer', fontSize: '16px' }}>x</button>
                                </div>
                            ) : (
                                <button
                                    onClick={() => fileRef.current?.click()}
                                    style={{
                                        width: '100%',
                                        padding: '16px',
                                        borderRadius: '10px',
                                        border: '2px dashed #3a3a3a',
                                        backgroundColor: 'transparent',
                                        color: '#666',
                                        fontSize: '13px',
                                        cursor: 'pointer',
                                    }}
                                >
                                    Click to upload reference
                                </button>
                            )}
                        </Card>

                        {/* Output */}
                        <Card>
                            <CardTitle>Output</CardTitle>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' }}>
                                {['mixed', 'vocal', 'bgm', 'separate'].map(mode => (
                                    <button
                                        key={mode}
                                        onClick={() => setOutputMode(mode)}
                                        style={{
                                            padding: '12px',
                                            borderRadius: '10px',
                                            border: outputMode === mode ? '1px solid #10B981' : '1px solid #3a3a3a',
                                            backgroundColor: outputMode === mode ? '#10B98115' : '#1e1e1e',
                                            color: outputMode === mode ? '#10B981' : '#777',
                                            cursor: 'pointer',
                                            fontSize: '13px',
                                            fontWeight: '500',
                                        }}
                                    >
                                        {mode === 'mixed' ? 'Full Song' : mode === 'vocal' ? 'Vocals' : mode === 'bgm' ? 'BGM' : 'Separate'}
                                    </button>
                                ))}
                            </div>
                        </Card>

                        {/* Song Title */}
                        <Card>
                            <CardTitle>Song Title</CardTitle>
                            <input
                                type="text"
                                value={title}
                                onChange={e => setTitle(e.target.value)}
                                placeholder="Enter song title..."
                                style={{
                                    width: '100%',
                                    backgroundColor: '#1e1e1e',
                                    border: '1px solid #3a3a3a',
                                    borderRadius: '10px',
                                    padding: '12px 14px',
                                    color: '#e0e0e0',
                                    fontSize: '14px',
                                    outline: 'none',
                                }}
                            />
                        </Card>
                    </aside>

                    {/* Main Content */}
                    <main style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '16px' }}>
                        {/* Structure */}
                        <Card>
                            <CardTitle>Structure</CardTitle>
                            <div style={{ display: 'flex', alignItems: 'center', gap: '6px', overflowX: 'auto', paddingBottom: '4px' }}>
                                {sections.map(s => {
                                    const { base, duration } = fromApiType(s.type);
                                    const cfg = SECTION_TYPES[base] || { name: base, color: '#888' };
                                    const isResizable = cfg.hasDuration;
                                    const widths = { short: 70, medium: 100 };
                                    const currentWidth = isResizable ? widths[duration] || widths.short : null;

                                    return (
                                        <div
                                            key={s.id}
                                            draggable={!isResizable}
                                            onDragStart={e => !isResizable && handleDragStart(e, s.id)}
                                            onDragOver={handleDragOver}
                                            onDrop={e => handleDrop(e, s.id)}
                                            style={{
                                                position: 'relative',
                                                width: isResizable ? currentWidth : 'auto',
                                                padding: isResizable ? '8px 6px 8px 10px' : '8px 16px',
                                                borderRadius: '8px',
                                                backgroundColor: cfg.color + '20',
                                                border: `2px solid ${cfg.color}`,
                                                color: cfg.color,
                                                fontSize: '12px',
                                                fontWeight: '500',
                                                cursor: isResizable ? 'default' : 'grab',
                                                whiteSpace: 'nowrap',
                                                display: 'flex',
                                                alignItems: 'center',
                                                justifyContent: 'space-between',
                                                boxSizing: 'border-box',
                                                flexShrink: 0,
                                            }}
                                        >
                                            <span
                                                draggable
                                                onDragStart={e => handleDragStart(e, s.id)}
                                                style={{ cursor: 'grab', display: 'flex', alignItems: 'center', gap: '4px' }}
                                            >
                                                {cfg.name}
                                                {isResizable && (
                                                    <span style={{
                                                        fontSize: '9px',
                                                        opacity: 0.6,
                                                        fontWeight: '400',
                                                    }}>
                                                        {duration === 'medium' ? '15s' : '5s'}
                                                    </span>
                                                )}
                                            </span>
                                            {isResizable && (
                                                <div
                                                    onMouseDown={(e) => {
                                                        e.preventDefault();
                                                        const startX = e.clientX;
                                                        const startWidth = currentWidth;

                                                        const onMouseMove = (moveE) => {
                                                            const delta = moveE.clientX - startX;
                                                            const newWidth = startWidth + delta;
                                                            // Snap to short or medium based on width
                                                            const threshold = (widths.short + widths.medium) / 2;
                                                            const newDuration = newWidth > threshold ? 'medium' : 'short';
                                                            if (newDuration !== duration) {
                                                                updateSection(s.id, { type: `${base}-${newDuration}` });
                                                            }
                                                        };

                                                        const onMouseUp = () => {
                                                            document.removeEventListener('mousemove', onMouseMove);
                                                            document.removeEventListener('mouseup', onMouseUp);
                                                        };

                                                        document.addEventListener('mousemove', onMouseMove);
                                                        document.addEventListener('mouseup', onMouseUp);
                                                    }}
                                                    style={{
                                                        width: '5px',
                                                        height: '16px',
                                                        marginLeft: '4px',
                                                        borderRadius: '2px',
                                                        backgroundColor: cfg.color + '50',
                                                        cursor: 'ew-resize',
                                                        display: 'flex',
                                                        flexDirection: 'column',
                                                        justifyContent: 'center',
                                                        alignItems: 'center',
                                                        gap: '2px',
                                                    }}
                                                    title={`${duration} (drag to resize)`}
                                                >
                                                    <div style={{ width: '2px', height: '2px', borderRadius: '50%', backgroundColor: cfg.color }} />
                                                    <div style={{ width: '2px', height: '2px', borderRadius: '50%', backgroundColor: cfg.color }} />
                                                </div>
                                            )}
                                        </div>
                                    );
                                })}
                                <button
                                    ref={addBtnRef}
                                    onClick={toggleAddMenu}
                                    style={{
                                        width: '32px',
                                        height: '32px',
                                        borderRadius: '8px',
                                        backgroundColor: '#1e1e1e',
                                        border: '2px solid #3a3a3a',
                                        color: '#666',
                                        fontSize: '18px',
                                        cursor: 'pointer',
                                        display: 'flex',
                                        alignItems: 'center',
                                        justifyContent: 'center',
                                        flexShrink: 0,
                                    }}
                                >+</button>
                            </div>
                        </Card>

                        {/* Section Cards */}
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {sections.map(s => (
                                <SectionCard key={s.id} section={s} onUpdate={u => updateSection(s.id, u)} onRemove={() => removeSection(s.id)} />
                            ))}
                        </div>
                    </main>
                </div>
            </div>

            {/* Library View */}
            <div style={{ display: activeTab === 'library' ? 'block' : 'none' }}>
                <div style={{ maxWidth: '900px', margin: '0 auto', padding: '0 24px' }}>
                    <h2 style={{ fontSize: '20px', fontWeight: '600', marginBottom: '20px', color: '#e0e0e0' }}>
                        Your Songs ({library.filter(l => l.status === 'completed').length})
                    </h2>
                    {library.length === 0 ? (
                        <div style={{ textAlign: 'center', padding: '60px', color: '#666' }}>
                            No songs generated yet. Start creating!
                        </div>
                    ) : (
                        <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                            {library.map(item => <LibraryItem key={item.id} item={item} />)}
                        </div>
                    )}
                </div>
            </div>
            </div>
            {/* End Scrollable Content Area */}

            {/* Add Section Popup - rendered at root level */}
            {showAddMenu && (
                <div
                    className="add-section-popup"
                    style={{
                        left: addMenuPos.x,
                        top: addMenuPos.y,
                        transform: addMenuPos.openUpward ? 'translateY(-100%)' : 'none',
                    }}
                >
                    {Object.entries(SECTION_TYPES)
                        .filter(([key]) => {
                            // Only allow one intro and one outro
                            if (key === 'intro' || key === 'outro') {
                                return !sections.some(s => {
                                    const { base } = fromApiType(s.type);
                                    return base === key;
                                });
                            }
                            return true;
                        })
                        .map(([key, val]) => (
                            <button key={key} onClick={() => addSection(key)} style={{ color: val.color }}>
                                + {val.name}
                            </button>
                        ))}
                </div>
            )}

            {/* Footer */}
            <footer style={{
                backgroundColor: '#232323',
                borderTop: '1px solid #333',
                padding: '14px 24px',
                display: 'flex',
                alignItems: 'center',
                gap: '16px',
                flexShrink: 0,
            }}>
                <button
                    onClick={generate}
                    disabled={generating}
                    style={{
                        backgroundColor: '#10B981',
                        color: '#fff',
                        border: 'none',
                        borderRadius: '10px',
                        padding: '14px 36px',
                        fontSize: '15px',
                        fontWeight: '600',
                        cursor: generating ? 'not-allowed' : 'pointer',
                        opacity: generating ? 0.7 : 1,
                    }}
                >
                    {generating ? 'Generating...' : 'Generate'}
                </button>

                {generating && (
                    <div style={{ flex: 1, display: 'flex', flexDirection: 'column', gap: '6px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                            <span style={{ fontSize: '13px', color: '#ccc' }}>{status}</span>
                            <span style={{ fontSize: '13px', color: '#10B981', fontWeight: '600' }}>
                                {estimatedTime ? formatTimeRemaining(Math.max(0, estimatedTime - elapsedTime)) : 'calculating...'}
                            </span>
                        </div>
                        <div
                            className="progress-bar-indeterminate"
                            style={{
                                height: '6px',
                                borderRadius: '3px',
                            }}
                        />
                    </div>
                )}

                {audio && !generating && (
                    <div style={{ flex: 1, display: 'flex', gap: '12px', alignItems: 'center' }}>
                        {audio.files?.map((f, i) => <DarkAudioPlayer key={i} src={`/api/audio/${audio.id}/${i}`} />)}
                    </div>
                )}

                {error && !generating && (
                    <div style={{ flex: 1, color: '#EF4444', fontSize: '13px', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' }}>
                        {error}
                    </div>
                )}
            </footer>
        </div>
    );
};

ReactDOM.createRoot(document.getElementById('root')).render(<App />);
</script>
</body>
</html>
